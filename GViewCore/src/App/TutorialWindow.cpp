#include "Internal.hpp"
#include <array>

using namespace GView::App;
using namespace AppCUI::Application;
using namespace AppCUI::Controls;
using namespace AppCUI::Input;
using namespace AppCUI::Utils;

constexpr uint32 canvasWidth  = 82; // 70d
constexpr uint32 canvasHeight = 15;

using TutorialStepData = std::vector<uint32>;
TutorialStepData step1 = {
    252117024, 252117062, 252117097, 252117100, 252117093, 252117024, 252117024, 252117061, 252117092, 252117097, 252117108, 252117024, 252117024, 252117068,
    252117089, 252117102, 252117095, 252117109, 252117089, 252117095, 252117093, 252117024, 252117024, 252117064, 252117093, 252117100, 252117104, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    17245524,  17236059,  17244561,
    17236061,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17236000,  17236039,  17236054,  17236073,  17236069,  17236087,  17236000,  17236052,  17236085,  17236084,  17236079,  17236082,  17236073,
    17236065,  17236076,  17236000,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17236059,  17236088,  17236061,  17245527,  468370,    468370,    17245521,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17245521,  468370,    468370,    17245521,  17236000,  17236055,  17236069,  17236076,  17236067,  17236079,
    17236077,  17236069,  17236000,  17236084,  17236079,  17236000,  17236084,  17236072,  17236069,  17236000,  17236039,  17236054,  17236073,  17236069,
    17236087,  17236000,  17236084,  17236085,  17236084,  17236079,  17236082,  17236073,  17236065,  17236076,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17245521,  468370,    468370,    17245521,  17236000,  17236041,  17236078,  17236000,  17236084,  17236072,  17236073,  17236083,
    17236000,  17236084,  17236085,  17236084,  17236079,  17236082,  17236073,  17236065,  17236076,  17236012,  17236000,  17236089,  17236079,  17236085,
    17236000,  17236087,  17236073,  17236076,  17236076,  17236000,  17236076,  17236069,  17236065,  17236082,  17236078,  17236000,  17236084,  17236072,
    17236069,  17236000,  17236039,  17236054,  17236073,  17236069,  17236087,  17236000,  17236073,  17236078,  17236084,  17236069,  17236082,  17236070,
    17236065,  17236067,  17236069,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17245521,  468370,    468370,    17245521,  17236000,  17236052,  17236079,  17236000,  17236069,  17236088,  17236073,  17236084,  17236012,  17236000,
    17236080,  17236082,  17236069,  17236083,  17236083,  17236000,  17236037,  17236051,  17236035,  17236000,  17236079,  17236082,  17236000,  17236084,
    17236072,  17236069,  17236000,  17236007,  17236056,  17236007,  17236000,  17236066,  17236085,  17236084,  17236084,  17236079,  17236078,  17236000,
    17236073,  17236078,  17236000,  17236084,  17236072,  17236069,  17236000,  17236084,  17236079,  17236080,  17236000,  17236082,  17236073,  17236071,
    17236072,  17236084,  17236000,  17236067,  17236079,  17236082,  17236078,  17236069,  17236082,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17245521,  468370,
    468370,    17245521,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17245521,  468370,    468370,    17245521,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17245521,  468370,    468370,    17245521,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17245521,  468370,    468370,    17245521,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,  17236000,
    17236000,  17236000,  17236000,  17236000,  17245521,  468370,    468370,    17245530,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,  17245520,
    17245520,  17245520,  17245464,  468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,    468370,
    252117024, 252117062, 252117041, 252117024, 252117059, 252117103, 252117101, 252117101, 252117089, 252117102, 252117092, 252117024, 252117041, 252117024,
    252117024, 252117062, 252117042, 252117024, 252117059, 252117103, 252117101, 252117101, 252117089, 252117102, 252117092, 252117024, 252117042, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
    252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024, 252117024,
};

class TutorialWindow : public Window, public Handlers::OnButtonPressedInterface
{
    Reference<AppCUI::Controls::ImageView> imgView;
    Reference<CanvasViewer> canvasViewer;
    Reference<Label> label1, label2;
    Reference<Button> backButton, nextButton;
    uint32 currentTutorialStep;
    std::vector<std::reference_wrapper<TutorialStepData>> tutorialSteps = { step1 };

  public:
    TutorialWindow() : Window("GView tutorial", "t:1,l:0,w:90,h:24", WindowFlags::Sizeable) // TODO: remove sizeable flag
    {
        currentTutorialStep = 0;

        label1 = Factory::Label::Create(this, "Welcome to the GView tutorial", "t:1,l:5,w:50");
        label2 = Factory::Label::Create(this, "You can follow the tutorial using the buttons bellow", "t:2,l:5,w:54");

        Factory::Button::Create(this, "PreviousStep", "t:4,l:10,w:13", 0, ButtonFlags::Flat);
        Factory::Button::Create(this, "NextStep", "t:4,l:30,w:10", 0, ButtonFlags::Flat);

        Factory::Label::Create(this, "------------------------------------------------------------", "t:5,l:5,w:54");

        LocalString<32> canvasLayout;
        canvasLayout.SetFormat("t:6,l:1,w:%u,h:%u", canvasWidth, canvasHeight);

        canvasViewer = Factory::CanvasViewer::Create(this, canvasLayout.GetText(), canvasWidth, canvasHeight, ViewerFlags::HideScrollBar);
        PrintCurrentStep();
    }

    void PrintCurrentStep()
    {
        auto stepVal = tutorialSteps[currentTutorialStep].get().begin();

        auto canvas  = canvasViewer->GetCanvas();
        Character* c = canvas->GetCharactersBuffer();
        Character* e = c + ((size_t) canvasWidth * (size_t) canvasHeight);

        while (c < e) {
            c->PackedValue = *stepVal;
            ++stepVal;
            c++;
        }
    }

    void OnButtonPressed(Reference<Controls::Button> r) override
    {
        this->Exit();
    }
};

void Instance::ShowTutorial()
{
    TutorialWindow tutorial{};
    tutorial.Show();
}